<?xml version="1.0" encoding="UTF-8"?>

<!--
  NOTES
  1) Please check the EasyEject uninstall check when upgrading to version > 2.39 as that version has a stupid space at the end
-->

<packages>

<package
  id="tp_airbag"
  name="ThinkPad HDD AirBag"
  revision="%version%-0"
  priority="10"
  reboot="false">

  <variable name="file" value="6isa10ww.exe" />
  <variable name="version" value="1.74" />

  <check type="uninstall" condition="versiongreaterorequal" path="ThinkVantage Active Protection System" value="%version%" />

  <install cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart"' />
  <install cmd='"%SYSTEMDRIVE%\SWTOOLS\readyapps\HPROTECT\setup.exe" /s /V"%MSI%"'>
    <exit code="3010" reboot="postponed" />
  </install>
  <upgrade cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart"' />
  <upgrade cmd='"%SYSTEMDRIVE%\SWTOOLS\readyapps\HPROTECT\setup.exe" /s /V"%MSI%"'>
    <exit code="3010" reboot="postponed" />
  </upgrade>
  <downgrade cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart"' />
  <downgrade cmd='"%SYSTEMDRIVE%\SWTOOLS\readyapps\HPROTECT\setup.exe" /s /V"%MSI%"'>
    <exit code="3010" reboot="postponed" />
  </downgrade>
  <remove  cmd='msiexec %MSI% /X{46A84694-59EC-48F0-964C-7E76E9F8A2ED}"' />
</package>

<!-- NOTES
  1) v2.39 writes a space at the end of the name in uninstall on the English version hence the duplicate check
  2) DisplayName will change with default system language
  3) Removed -l0x9 (English) and -l0x6 (Danish) from uninstaller, as we don't care about language
  4) Item 3 is moot as silent uninstaller doesn't work for two reasons: a) -s is not supported  and b) rundll32 only accepts shortnames
-->

<package
  id="tp_ezeject"
  name="ThinkPad EasyEject"
  revision="%version%-6"
  priority="12"
  reboot="false">

  <variable name="file" value="7zu205ww.exe" />
  <variable name="version" value="2.39" />
  <variable name="tempdir" value="%SYSTEMDRIVE%\SWTOOLS\DRIVERS\EZEJECT" />

  <check type="logical" condition="or">
    <check type="uninstall" condition="versiongreaterorequal" path="ThinkPad EasyEject Utility " value="%version%" /> <!-- do not remove, see notes -->
    <check type="uninstall" condition="versiongreaterorequal" path="ThinkPad EasyEject Utility" value="%version%" />
    <check type="uninstall" condition="versiongreaterorequal" path="ThinkPad EasyEject-funktioner" value="%version%" /> <!-- Danish -->
  </check>

  <install   cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart' />
  <install   cmd='%COMSPEC% /c copy /y "%SOFTWARE%\ThinkPad\easyeject_setup.iss" "%tempdir%\setup.iss"' />
  <install   cmd='%tempdir%\setup.exe /s /sms /f1%tempdir%\setup.iss' />

  <upgrade   cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart' />
  <upgrade   cmd='%COMSPEC% /c copy /y "%SOFTWARE%\ThinkPad\easyeject_setup.iss" "%tempdir%\setup.iss"' />
  <upgrade   cmd='%tempdir%\setup.exe /s /sms /f1%tempdir%\setup.iss' />

  <downgrade cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart' />
  <downgrade cmd='%COMSPEC% /c copy /y "%SOFTWARE%\ThinkPad\easyeject_setup.iss" "%tempdir%\setup.iss"' />
  <downgrade cmd='%tempdir%\setup.exe /s /sms /f1%tempdir%\setup.iss' />

</package>

<!--
  NOTES
  1) Turns out the uninstall name is different between computers on XP (haven't verified w7). Great...
  2) It looks like WPKG doesn't do variable expension in sub-processes hence /passive /norestart instead of %MSI%
-->

<package
  id="tp_systemupdate"
  name="ThinkPad System Update"
  revision="%version_xp%-5"
  priority="10"
  reboot="false">

  <variable name="dir_xp" value="%SOFTWARE%\ThinkPad\systemupdate314-2010-10-29" />
  <variable name="dir_w7" value="%SOFTWARE%\ThinkPad\systemupdate40-2011-02-18" />
  <variable name="version_xp" value="3.14.0031" />
  <variable name="version_w7" value="4.0.0046" />

  <check type="logical" condition="or">
    <check type="uninstall" condition="versiongreaterorequal" path="System Update" value="%version_xp%" />
    <check type="uninstall" condition="versiongreaterorequal" path="ThinkVantage System Update" value="%version_xp%" />
    <check type="uninstall" condition="versiongreaterorequal" path="ThinkVantage System Update" value="%version_w7%" />
  </check>

  <install   cmd='"%dir_xp%\setup.exe" /S /V"/passive /norestart"'>
    <exit code="3010" reboot="postponed" />
  </install>
  <upgrade   cmd='"%dir_xp%\setup.exe" /S /V"/passive /norestart"'>
    <exit code="3010" reboot="postponed" />
  </upgrade>
  <downgrade cmd='"%dir_xp%\setup.exe" /S /V"/passive /norestart"'>
    <exit code="3010" reboot="postponed" />
  </downgrade>
  <remove    cmd='"%dir_xp%\setup.exe" /S /V"/passive /norestart"'>
    <exit code="3010" reboot="postponed" />
  </remove>

</package>

</packages>
