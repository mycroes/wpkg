<?xml version="1.0" encoding="UTF-8"?>

<!--
  NOTES
  1) Please check the EasyEject uninstall check when upgrading to version > 2.39 as that version has a stupid space at the end
-->

<packages xmlns:xsi="http://www.wpkg.org/packages" xsi:noNamespaceSchemaLocation="xsd/packages.xsd">

<package
  id="tp_airbag"
  name="ThinkPad HDD AirBag"
  revision="%version%-1"
  priority="10"
  reboot="false">

  <variable name="file" value="8isa01ww.exe" architecture="x86" />
  <variable name="file" value="8isk01ww.exe" architecture="x64" />
  <variable name="version" value="1.74" />

  <check type="uninstall" condition="versiongreaterorequal" path="ThinkVantage Active Protection System" value="%version%" />

  <install cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart"' />
  <install cmd='"%SYSTEMDRIVE%\SWTOOLS\readyapps\HPROTECT\setup.exe" /s /V"%MSI%"'>
    <exit code="3010" reboot="postponed" />
  </install>
  <upgrade cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart"' />
  <upgrade cmd='"%SYSTEMDRIVE%\SWTOOLS\readyapps\HPROTECT\setup.exe" /s /V"%MSI%"'>
    <exit code="3010" reboot="postponed" />
  </upgrade>
  <downgrade cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart"' />
  <downgrade cmd='"%SYSTEMDRIVE%\SWTOOLS\readyapps\HPROTECT\setup.exe" /s /V"%MSI%"'>
    <exit code="3010" reboot="postponed" />
  </downgrade>
  <remove  cmd='msiexec %MSI% /X{46A84694-59EC-48F0-964C-7E76E9F8A2ED}"' />
</package>

<!-- NOTES
  1) v2.39 writes a space at the end of the name in uninstall on the English version hence the duplicate check
  2) DisplayName will change with default system language
  3) Removed -l0x9 (English) and -l0x6 (Danish) from uninstaller, as we don't care about language
  4) Item 3 is moot as silent uninstaller doesn't work for two reasons: a) -s is not supported  and b) rundll32 only accepts shortnames
-->

<package
  id="tp_ezeject"
  name="ThinkPad EasyEject"
  revision="%version%-6"
  priority="12"
  reboot="false">

  <variable name="file" value="7zu205ww.exe" />
  <variable name="version" value="2.39" />
  <variable name="tempdir" value="%SYSTEMDRIVE%\SWTOOLS\DRIVERS\EZEJECT" />

  <check type="uninstall" condition="versiongreaterorequal" path="ThinkPad EasyEject.+" value="%version%" />

  <install   cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart' />
  <install   cmd='%COMSPEC% /c copy /y "%SOFTWARE%\ThinkPad\easyeject_setup.iss" "%tempdir%\setup.iss"' />
  <install   cmd='%tempdir%\setup.exe /s /sms /f1%tempdir%\setup.iss' />

  <upgrade   cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart' />
  <upgrade   cmd='%COMSPEC% /c copy /y "%SOFTWARE%\ThinkPad\easyeject_setup.iss" "%tempdir%\setup.iss"' />
  <upgrade   cmd='%tempdir%\setup.exe /s /sms /f1%tempdir%\setup.iss' />

  <downgrade cmd='"%SOFTWARE%\ThinkPad\%file%" /VERYSILENT /norestart' />
  <downgrade cmd='%COMSPEC% /c copy /y "%SOFTWARE%\ThinkPad\easyeject_setup.iss" "%tempdir%\setup.iss"' />
  <downgrade cmd='%tempdir%\setup.exe /s /sms /f1%tempdir%\setup.iss' />

</package>

<!--
  NOTES
  1) Turns out the uninstall name is different between computers on XP (haven't verified w7). Great...
  2) It looks like WPKG doesn't do variable expension in sub-processes hence /passive /norestart instead of %MSI%

  INSTALLER
  1) Download .exe from lenovo.com
  2) Use 7z to extract into folder
  3) Run psaddzip.exe - this creates a setup directory at the install source
-->

<package
  id="tp_systemupdate"
  name="ThinkPad System Update"
  revision="%version%-0"
  priority="10"
  reboot="false">

  <variable name="source" value="%SOFTWARE%\ThinkPad\systemupdate315-2011-07-25" os="windows xp" />
  <variable name="source" value="%SOFTWARE%\ThinkPad\systemupdate401-2011-07-25" os="windows 7" />
  <variable name="version" value="3.15.0000" os="windows xp" />
  <variable name="version" value="4.01.0000" os="windows 7" />

  <check type="logical" condition="or">
    <check type="uninstall" condition="versiongreaterorequal" path="System Update" value="%version%" />
    <check type="uninstall" condition="versiongreaterorequal" path="ThinkVantage System Update" value="%version%" />
  </check>

  <install cmd='"%dir%\setup.exe" /S /V"/quiet /norestart"'>
    <exit code="3010" reboot="postponed" />
  </install>
  <upgrade cmd='"%dir%\setup.exe" /S /V"/quiet /norestart"'>
    <exit code="3010" reboot="postponed" />
  </upgrade>
  <downgrade cmd='"%dir%\setup.exe" /S /V"/quiet /norestart"'>
    <exit code="3010" reboot="postponed" />
  </downgrade>
  <remove cmd='msiexec %MSI% /x "%dir%\System Update.msi"'>
    <exit code="3010" reboot="postponed" />
  </remove>

</package>

</packages>
